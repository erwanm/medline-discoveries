---
title: "Mining Impactful Discoveries 1: Detecting Surges"
author: "Erwan Moreau"
date: "November 2021"
output:
 html_document:
    fig_width: 10
    fig_height: 4
---


```{r setup, include=FALSE}
library(knitr)
library(rmarkdown)
library(ggplot2)
source('discoveries4.R')
knitr::opts_chunk$set(echo = TRUE)
# TODO temporary path
dataPath <- '../data/21-extract-discoveries/recompute-with-ND-group/MED'
dataPathStatic <- paste(dataPath,'across-all-years',sep='/')
indivFileStatic <- 'indiv.min100.ND.terms'
```

```{r load}
dynamic_joint <- loadDynamicData(dataPath,indivOrJoint = 'joint')
dynamic_indiv <- loadDynamicData(dataPath,indivOrJoint = 'indiv')
dynamic_total <- loadDynamicTotalFile(dataPath)
static_data <- loadStaticData(dataPathStatic)
```


# Examples frequency across years

## Generating random examples

A single pair of concepts can be picked randomly as follows:

```{r rnd1}
relation<-pickRandomDynamic(dynamic_joint)
```

In order to avoid cases with insufficient data, it is possible to filter out rows with less than some minimum frequency $m$ (the relation must have at least one year with a frequency higher than $m$). It is also possible to specify the number of cases to pick:

```{r rnd2}
three_relations<-pickRandomDynamic(dynamic_joint,n=3, minFreqYear = 200)
```

## Displaying a single relation with its concepts names

```{r display1}
displaySeveralPairsData(relation,static_data,dynamic_total)
```


```{r display2}
displaySeveralPairsData(three_relations,static_data,dynamic_total)
```

## Selecting the ALS cases presented in the paper

```{r als}
als <- filterConcepts(dynamic_joint, 'D000690')
selectedALS <- filterConcepts(als,c('D051379','D000073885','D000870','D019782','D008875'))
```

```{r expl1}
g<-displaySeveralPairsData(selectedALS,static_data,dynamic_total,excludeConceptsFromName = 'D000690',ncol=5)
g
# saving the graph as pdf:
# ggsave('expl1.pdf',g)
```


# Trend parameters

## Using simple frequency, indicator 'rate'

```{r trend1}
displayMultiTrend(selectedALS,dynamic_indiv,dynamic_total,static_data,indicator='rate',valueCol = 'prob',excludeConceptsFromName = 'D000690')
```

## Using NMI, indicator 'rate'

```{r trend2}
displayMultiTrend(selectedALS,dynamic_indiv,dynamic_total,static_data,indicator='rate',valueCol = 'nmi',excludeConceptsFromName = 'D000690')
```

## Using NMI, indicator 'diff'

```{r trend3}
displayMultiTrend(selectedALS,dynamic_indiv,dynamic_total,static_data,indicator='diff',valueCol = 'nmi',excludeConceptsFromName = 'D000690')
```



# Example indicators and surges

## Using simple frequency

```{r surges1}
parkinson <- filterConcepts(dynamic_joint, 'D010300')
case <- filterConcepts(parkinson, 'D013378')
g <- displaySurges(case,dynamic_indiv,dynamic_total,static_data,windows=c(1,3), indicators=c('rate','diff'),withTitle = TRUE)
g
# saving the graph as pdf:
# ggsave('expl1.pdf',g)
```

## Using NMI

```{r surges2}
parkinson <- filterConcepts(dynamic_joint, 'D010300')
case <- filterConcepts(parkinson, 'D013378')
g <- displaySurges(case,dynamic_indiv,dynamic_total,static_data,valueCol='nmi',windows=c(1,3,5), indicators=c('rate','diff'),withTitle = TRUE)
g
# saving the graph as pdf:
# ggsave('expl1.pdf',g)
```

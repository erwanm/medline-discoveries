---
title: "Mining Impactful Discoveries 3: Analysis"
author: "Erwan Moreau"
date: "November 2021"
output:
 html_document:
    fig_width: 10
    fig_height: 4
---


```{r setup, include=FALSE}
library(knitr)
library(rmarkdown)
library(ggplot2)
source('discoveries4.R')
knitr::opts_chunk$set(echo = TRUE)
# TODO temporary path
dataPath <- '../data/21-extract-discoveries/recompute-with-ND-group/MED'
dataPathStatic <- paste(dataPath,'across-all-years',sep='/')
indivFileStatic <- 'indiv.min100.ND.terms'
# set to TRUE for short execution with a subset of data
shortVersion <- TRUE
savePaperGraphs <- TRUE
```

# datasets

## Loading

```{r load}
dynamic_joint <- loadDynamicData(dataPath,indivOrJoint = 'joint')
dynamic_indiv <- loadDynamicData(dataPath,indivOrJoint = 'indiv')
dynamic_total <- loadDynamicTotalFile(dataPath)
static_data <- loadStaticData(dataPathStatic)
```


## Selecting the specific concepts presented in the paper

```{r als}
als <- filterConcepts(dynamic_joint, 'D000690')
selectedALS <- filterConcepts(als,c('D051379','D000073885','D000870','D019782','D008875'))
parkinson <- filterConcepts(dynamic_joint, 'D010300')
caseParkinson <- filterConcepts(parkinson, 'D013378')
```


```{r, init.data.short, echo=shortVersion, eval=shortVersion}
dynamic_joint<-pickRandomDynamic(dynamic_joint,n=300)
```


# Visualizing frequency across time

## Generating random examples

A single pair of concepts can be picked randomly as follows:

```{r rnd1}
relation<-pickRandomDynamic(dynamic_joint)
```

In order to avoid cases with insufficient data, it is possible to filter out rows with less than some minimum frequency $m$ (the relation must have at least one year with a frequency higher than $m$). It is also possible to specify the number of cases to pick:

```{r rnd2}
three_relations<-pickRandomDynamic(dynamic_joint,n=3, minFreqYear = 200)
```

## Displaying relations with their concepts names

Using the relations selected randomly above:

```{r display1}
displaySeveralPairsData(relation,static_data,dynamic_total)
```


```{r display2}
displaySeveralPairsData(three_relations,static_data,dynamic_total)
```

## Displaying the ALS cases


```{r expl1}
g<-displaySeveralPairsData(selectedALS,static_data,dynamic_total,excludeConceptsFromName = 'D000690',ncol=5)
g
```

```{r expl1.save, echo=savePaperGraphs, eval=savePaperGraphs}
ggsave('expl1.pdf',g)
```

# Measures

```{r measures1}
g <- displayMultiMeasure(selectedALS,dynamic_indiv,dynamic_total,static_data,windows=c(1,3,5),measures=c('prob.joint','pmi','npmi','mi','nmi'),excludeConceptsFromName = 'D000690')
g
```


```{r measures1.save, echo=savePaperGraphs, eval=savePaperGraphs}
ggsave('expl-measures.pdf',g+ theme(text=element_text(size=14),legend.position="none",axis.title.x=element_blank(),axis.title.y=element_blank()),width=20,height=16,units = "cm")
```

# Trend parameters

## Using simple frequency, indicator 'rate'

```{r trend1}
displayMultiTrend(selectedALS,dynamic_indiv,dynamic_total,static_data,indicator='rate',measure = 'prob.joint',excludeConceptsFromName = 'D000690')
```

## Using NMI, indicator 'rate'

```{r trend2}
displayMultiTrend(selectedALS,dynamic_indiv,dynamic_total,static_data,indicator='rate',measure = 'nmi',excludeConceptsFromName = 'D000690')
```

## Using NMI, indicator 'diff'

```{r trend3}
displayMultiTrend(selectedALS,dynamic_indiv,dynamic_total,static_data,indicator='diff',measure = 'nmi',excludeConceptsFromName = 'D000690')
```



# Example indicators and surges

## Using simple frequency

```{r surges1}
g <- displaySurges(caseParkinson,dynamic_indiv,dynamic_total,static_data,windows=c(1,3), indicators=c('rate','diff'),withTitle = TRUE)
g
# saving the graph as pdf:
# ggsave('expl1.pdf',g)
```

## Using NMI

```{r surges2}
g <- displaySurges(caseParkinson,dynamic_indiv,dynamic_total,static_data,valueCol='nmi',windows=c(1,3,5), indicators=c('rate','diff'),withTitle = TRUE)
g
# saving the graph as pdf:
# ggsave('expl1.pdf',g)
```

# Trend distribution


## 'Standard' version



```{r sample.ma}
relations.ma <- computeMovingAverage(dynamic_joint,dynamic_total, window=5)
indiv.ma <- computeMovingAverage(dynamic_indiv,dynamic_total, window=5)
```

The following graphs show different versions of the histogram of the `trend` values: with/without logarithmic scale on the X and/or Y axis.

The vertical lines show the outlier threshold calculated as $Q_3+k \times IQR$, where $k$ is either 1.5 or 3 ("far outliers").

```{r trend.distrib1}
l<-displayTrendDistribution1(relations.ma,indiv.ma)
l$x0.y0
l$x0.y1
l$x1.y0
l$x1.y1
```

## "Flat" distribution

These graphs show the "flat" distribution (not sure if it has a standard name): 

- The points are sorted by `trend` and their relative rank (rank divided by number of points) is plotted as X. In other words, the X axis represents all the quantile positions with respect to `trend`.
- The `trend` value shown on the Y axis is normalized between [0,1] for every measure.

```{r trend.distrib2}
displayTrendDistribution2(relations.ma,indiv.ma,withRect = FALSE)
```